# 🎮 유저 관점에서 본 게임 플로우

## 유저가 경험하는 것 (User Experience)

### 1단계: 로비에서 대기 👥
```
유저 화면: [로비]
- "방 만들기" 버튼 클릭 → 방 코드 생성됨 (예: 123456)
- 친구들 대기 중...
- "플레이어2 입장!" 알림
- "플레이어3 입장!" 알림
- "플레이어4 입장!" 알림
```

**백그라운드:**
- 프론트엔드 ↔ 서버: WebSocket 연결 유지
- 각 플레이어가 JOIN_ROOM으로 입장

---

### 2단계: 4명 모임 → 게임 시작 준비 🎯
```
유저 화면: [로비]
- "4명이 모였습니다! 게임 시작!"
- 화면이 Unity 게임으로 전환
- 로딩 화면...
```

**백그라운드:**
- 서버 → 프론트엔드: `GAME_READY` 전송
- 프론트엔드: Unity 게임 실행, 토큰+방코드 전달
- Unity: 서버에 **새로운** WebSocket 연결 생성 (프론트엔드와 별개)
- Unity → 서버: `CONNECT_GAME` (방코드: 123456)
- 서버: 토큰으로 **같은 유저**임을 확인 ✅
- 서버: 방 123456의 게임 세션에 추가

**중요:** 
1. **로비 연결은 유지됩니다** (게임 종료 후 사용)
2. Unity는 **별도의 WebSocket 연결**을 생성합니다
3. 같은 서버, 같은 토큰이지만 **독립적인 세션** 2개가 존재
4. 서버는 토큰을 통해 "아, 이 Unity 연결이 아까 로비에서 입장했던 그 유저구나!"라고 인식합니다.

### 3단계: 게임 시작 🎮
```
유저 화면: [Unity 게임]
- "게임 시작!"
- 질문 표시: "가장 좋아하는 음식은?"
- 출제자: 플레이어1 (노란색 표시)
- 나와 다른 2명은 카드 선택
```

**백그라운드:**
- 4명의 Unity가 모두 `CONNECT_GAME` 완료
- 서버 → 4명의 Unity: `GAME_START` 전송
  ```json
  {
    "type": "GAME_START",
    "room_code": "123456",
    "data": {
      "participants": [
        { "user_id": 1, "nickname": "나", "is_examiner": false },
        { "user_id": 2, "nickname": "친구1", "is_examiner": true },
        { "user_id": 3, "nickname": "친구2", "is_examiner": false },
        { "user_id": 4, "nickname": "친구3", "is_examiner": false }
      ],
      "question": { "content": "가장 좋아하는 음식은?" }
    }
  }
  ```

---

### 4단계: 게임 진행 🃏
```
유저 화면: [Unity 게임]
- 내 카드: "치킨" 선택 → 제출 버튼 클릭
- "카드 제출 완료!" 표시
- 다른 플레이어들도 제출 중...
- "모두 제출 완료!"
- 출제자가 선택 중...
- "친구2가 선택되었습니다! +1점"
```

**백그라운드:**
```
나(Unity) → 서버: SUBMIT_CARD { card_id: 42 }
나(Unity) ← 서버: CARD_SUBMITTED (제출 확인)

[3명 모두 제출]
출제자(Unity) ← 서버: ALL_CARDS_SUBMITTED (제출된 카드 목록)

출제자(Unity) → 서버: EXAMINER_SELECT { participant_id: 3 }
4명(Unity) ← 서버: EXAMINER_SELECTED (선택 결과 + 점수)
```

**서버는 방 123456의 게임 세션으로만 메시지를 전송** → 올바른 4명에게만 전달됨 ✅

---

### 5단계: 다음 라운드 🔄
```
유저 화면: [Unity 게임]
- "다음 라운드!"
- 새 출제자: 친구2 (노란색 표시)
- 새 질문: "가장 가고 싶은 여행지는?"
- 다시 카드 선택...
```

**백그라운드:**
```
서버 → 4명(Unity): NEXT_ROUND
{
  "examinerNickname": "친구2",
  "question": { "content": "가장 가고 싶은 여행지는?" }
}
```

---

### 6단계: 게임 종료 🏆
```
유저 화면: [Unity 게임]
- "게임 종료!"
- 최종 순위:
  1위: 친구3 (5점) 🥇 +20 EXP
  2위: 나 (3점) 🥈 +10 EXP
  3위: 친구2 (2점) 🥉 +5 EXP
  4위: 친구1 (1점) +2 EXP
- "로비로 돌아가기" 버튼
```

**백그라운드:**
```
서버 → 4명(Unity): ROUND_END (최종 순위 + 경험치)
Unity: WebSocket 연결 종료
프론트엔드: 로비 화면으로 전환 (로비 연결은 계속 유지되어 있음!)
```

---

## ✅ 유저 입장에서 검증

### Q: 유저가 이상한 점을 느낄까요?
**A: 아니요! 완전히 자연스럽습니다.**

### 유저가 보는 것:
1. ✅ 로비에서 4명 모임
2. ✅ 자동으로 게임 화면(Unity)으로 전환
3. ✅ 게임 시작
4. ✅ 내 닉네임과 다른 3명의 닉네임 정확히 표시
5. ✅ 출제자 구분 정확
6. ✅ 카드 제출하면 바로 반영
7. ✅ 출제자가 선택하면 점수 올라감
8. ✅ 다음 라운드 진행
9. ✅ 게임 종료 후 로비 복귀

### 유저가 모르는 것 (알 필요 없음):
- ❌ 프론트엔드와 Unity가 별도 연결인지
- ❌ `GAME_READY`나 `CONNECT_GAME` 같은 메시지
- ❌ 서버가 토큰으로 유저를 인식하는 과정
- ❌ 로비 연결이 유지되는지

---

## 🔍 서버가 같은 유저임을 인식하는 방법

### 1. 프론트엔드 로비 연결
```java
// 핸드셰이크 시
Authentication auth = jwtProvider.authentication(token);
// 토큰 디코딩: { user_id: 1, nickname: "나" }

// JOIN_ROOM 처리
User user = (User) session.getAttributes().get("userPrincipal");
// user.getId() = 1, user.getNickname() = "나"
participant.setUserId(user);  // DB에 저장
```

### 2. Unity 게임 연결
```java
// 핸드셰이크 시 (같은 토큰!)
Authentication auth = jwtProvider.authentication(token);
// 토큰 디코딩: { user_id: 1, nickname: "나" }

// CONNECT_GAME 처리
User user = (User) session.getAttributes().get("userPrincipal");
// user.getId() = 1, user.getNickname() = "나"

// DB에서 방 123456의 참가자 조회
var participant = participantRepository.findByRoomIdIdAndUserIdId(
    room.getId(),    // 방 123456
    user.getId()     // userId = 1
);
// ✅ 찾음! 이 유저는 이미 이 방에 참가한 유저임
```

### 결과:
- ✅ 서버는 **같은 토큰 → 같은 userId → 같은 참가자**임을 인식
- ✅ 같은 방(123456)의 게임 세션에 추가
- ✅ 4명이 모두 연결되면 `GAME_START` 전송
- ✅ 게임 진행 중 메시지는 방 123456의 게임 세션으로만 전송

---

## 🎯 핵심 포인트

### 1. 동일성 보장 (Identity)
```
로비에서의 나 = 게임에서의 나
(같은 토큰 → 같은 userId → 같은 Participant)
```

### 2. 격리성 (Isolation)
```
방 123456의 게임 메시지는 방 123456의 Unity들에게만 전송
방 789012의 게임은 완전히 독립적
```

### 3. 상태 유지 (State Persistence)
```
출제자 지정 → DB에 저장
점수 → DB에 저장
다음 라운드 시 상태 그대로 유지
```

### 4. 원활한 전환 (Seamless Transition)
```
로비 → Unity: 자동 전환, 유저는 클릭 없이 자연스럽게 게임 시작
게임 → 로비: 로비 연결 유지되어 있어 즉시 복귀 가능
```

---

## 🧪 테스트 시나리오

### 정상 플로우
1. ✅ 4명이 순서대로 로비 입장
2. ✅ 4명의 Unity가 순서대로 게임 연결
3. ✅ `GAME_START` 수신 시 4명 모두 같은 질문 받음
4. ✅ 출제자가 아닌 3명만 카드 제출 가능
5. ✅ 출제자만 `ALL_CARDS_SUBMITTED` 받음
6. ✅ 선택된 사람의 점수만 올라감
7. ✅ 다음 라운드에서 출제자 변경
8. ✅ 5점 달성 시 게임 종료

### 예외 상황
- **Unity 연결 순서가 달라도**: ✅ 문제없음 (토큰으로 식별)
- **일부만 연결 끊김**: ⚠️ 현재는 재연결 로직 없음 (향후 추가 필요)
- **같은 유저가 두 번 연결**: ✅ 방지됨 (이미 게임 세션에 있음)

---

## 📊 데이터 흐름

```
┌─────────────┐         ┌─────────────┐         ┌─────────────┐
│  프론트엔드  │         │    서버     │         │    Unity    │
│  (유저 화면) │         │            │         │  (게임 화면) │
└─────────────┘         └─────────────┘         └─────────────┘
       │                       │                       │
       │--WebSocket(token)-->  │                       │
       │  JOIN_ROOM(123456)    │                       │
       │<--USER_JOINED---------|                       │
       │                       │                       │
       │  [4명 입장]            │                       │
       │<--GAME_READY----------|                       │
       │                       │                       │
       │  Unity 실행            │                       │
       ├---------------------->│                       │
       │  (token, roomCode)    │<--WebSocket(token)---|
       │                       │                       │
       │                       │<--CONNECT_GAME--------|
       │                       │   (room_code:123456)   │
       │                       │                       │
       │                       │  [토큰 검증]           │
       │                       │  userId = 1           │
       │                       │  room_code = 123456    │
       │                       │  → 같은 유저 확인 ✅   │
       │                       │                       │
       │                       │  [4명 Unity 연결]     │
       │                       │--GAME_START---------->│
       │                       │   (같은 방 4명에게만) │
       │                       │                       │
       │  [로비 연결 유지]       │<--SUBMIT_CARD--------|
       │                       │--CARD_SUBMITTED------>│
       │                       │                       │
       │                       │--EXAMINER_SELECTED--->│
       │                       │--NEXT_ROUND---------->│
       │                       │--ROUND_END----------->│
       │                       │                       │
       │<--게임 종료 알림-------|                       │
       │  로비 복귀             │                       │
```

---

## ✅ 결론

**유저 입장에서는 아무런 이상 없이 자연스럽게 게임이 진행됩니다!**

### 이유:
1. ✅ **같은 토큰** 사용 → 서버가 같은 유저임을 정확히 인식
2. ✅ **같은 방 코드** 사용 → 같은 게임 세션에 참여
3. ✅ **DB에 저장된 Participant** → 출제자, 점수 등 상태 유지
4. ✅ **게임 세션 격리** → 다른 방과 메시지 섞이지 않음
5. ✅ **자동 게임 시작** → 4명 Unity 연결되면 즉시 시작

### 유저 경험:
- 로비 대기 → 자동으로 게임 화면 전환 → 게임 플레이 → 로비 복귀
- **끊김 없이 자연스러운 플로우** 🎮✨

---

**테스트 필요:** 실제로 4명이 연결해서 전체 플로우를 테스트해보세요!

